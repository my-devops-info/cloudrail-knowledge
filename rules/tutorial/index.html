
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      <link rel="icon" href="../../assets/favicon.ico">
      <meta name="generator" content="mkdocs-1.2.1, mkdocs-material-7.1.8">
    
    
      
        <title>Tutorial - Writing Your Own Rule - Cloudrail Knowledge</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.ca7ac06f.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.f1a3b89f.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    
      


    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    <script>function __prefix(e){return new URL("../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#tutorial-writing-your-own-rule" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../index.html" title="Cloudrail Knowledge" class="md-header__button md-logo" aria-label="Cloudrail Knowledge" data-md-component="logo">
      
  <img src="../../assets/cloudrail_small_logo.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Cloudrail Knowledge
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Tutorial - Writing Your Own Rule
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        
<a href="https://github.com/indeni/cloudrail-knowledge/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    cloudrail-knowledge
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../index.html" title="Cloudrail Knowledge" class="md-nav__button md-logo" aria-label="Cloudrail Knowledge" data-md-component="logo">
      
  <img src="../../assets/cloudrail_small_logo.svg" alt="logo">

    </a>
    Cloudrail Knowledge
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/indeni/cloudrail-knowledge/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    cloudrail-knowledge
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../index.html" class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      <label class="md-nav__link" for="__nav_2">
        Context
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Context" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Context
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../context/index.html" class="md-nav__link">
        Cloudrail's Context Model
      </a>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_2" type="checkbox" id="__nav_2_2" >
      
      <label class="md-nav__link" for="__nav_2_2">
        AWS Context
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="AWS Context" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_2">
          <span class="md-nav__icon md-icon"></span>
          AWS Context
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../context/aws/account/index.html" class="md-nav__link">
        account
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../context/aws/apigateway/index.html" class="md-nav__link">
        apigateway
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../context/aws/apigatewayv2/index.html" class="md-nav__link">
        apigatewayv2
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../context/aws/athena/index.html" class="md-nav__link">
        athena
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../context/aws/autoscaling/index.html" class="md-nav__link">
        autoscaling
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../context/aws/batch/index.html" class="md-nav__link">
        batch
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../context/aws/cloudfront/index.html" class="md-nav__link">
        cloudfront
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../context/aws/cloudhsmv2/index.html" class="md-nav__link">
        cloudhsmv2
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../context/aws/cloudtrail/index.html" class="md-nav__link">
        cloudtrail
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../context/aws/cloudwatch/index.html" class="md-nav__link">
        cloudwatch
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../context/aws/codebuild/index.html" class="md-nav__link">
        codebuild
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../context/aws/configservice/index.html" class="md-nav__link">
        configservice
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../context/aws/dax/index.html" class="md-nav__link">
        dax
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../context/aws/dms/index.html" class="md-nav__link">
        dms
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../context/aws/docdb/index.html" class="md-nav__link">
        docdb
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../context/aws/ds/index.html" class="md-nav__link">
        ds
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../context/aws/dynamodb/index.html" class="md-nav__link">
        dynamodb
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../context/aws/ec2/index.html" class="md-nav__link">
        ec2
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../context/aws/ecr/index.html" class="md-nav__link">
        ecr
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../context/aws/ecs/index.html" class="md-nav__link">
        ecs
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../context/aws/efs/index.html" class="md-nav__link">
        efs
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../context/aws/eks/index.html" class="md-nav__link">
        eks
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../context/aws/elasticache/index.html" class="md-nav__link">
        elasticache
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../context/aws/elb/index.html" class="md-nav__link">
        elb
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../context/aws/emr/index.html" class="md-nav__link">
        emr
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../context/aws/es/index.html" class="md-nav__link">
        es
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../context/aws/glacier/index.html" class="md-nav__link">
        glacier
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../context/aws/globalaccelerator/index.html" class="md-nav__link">
        globalaccelerator
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../context/aws/glue/index.html" class="md-nav__link">
        glue
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../context/aws/iam/index.html" class="md-nav__link">
        iam
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../context/aws/kinesis/index.html" class="md-nav__link">
        kinesis
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../context/aws/kms/index.html" class="md-nav__link">
        kms
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../context/aws/lambda_/index.html" class="md-nav__link">
        lambda_
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../context/aws/mq/index.html" class="md-nav__link">
        mq
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../context/aws/neptune/index.html" class="md-nav__link">
        neptune
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../context/aws/networking_config/index.html" class="md-nav__link">
        networking_config
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../context/aws/rds/index.html" class="md-nav__link">
        rds
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../context/aws/redshift/index.html" class="md-nav__link">
        redshift
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../context/aws/resourcegroupstaggingapi/index.html" class="md-nav__link">
        resourcegroupstaggingapi
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../context/aws/s3/index.html" class="md-nav__link">
        s3
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../context/aws/s3outposts/index.html" class="md-nav__link">
        s3outposts
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../context/aws/sagemaker/index.html" class="md-nav__link">
        sagemaker
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../context/aws/secretsmanager/index.html" class="md-nav__link">
        secretsmanager
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../context/aws/sns/index.html" class="md-nav__link">
        sns
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../context/aws/sqs/index.html" class="md-nav__link">
        sqs
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../context/aws/ssm/index.html" class="md-nav__link">
        ssm
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../context/aws/worklink/index.html" class="md-nav__link">
        worklink
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../context/aws/workspaces/index.html" class="md-nav__link">
        workspaces
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../context/aws/xray/index.html" class="md-nav__link">
        xray
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_3" type="checkbox" id="__nav_2_3" >
      
      <label class="md-nav__link" for="__nav_2_3">
        Azure Context
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Azure Context" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_3">
          <span class="md-nav__icon md-icon"></span>
          Azure Context
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../context/azure/databases/index.html" class="md-nav__link">
        databases
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../context/azure/network/index.html" class="md-nav__link">
        network
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../context/azure/webapp/index.html" class="md-nav__link">
        webapp
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" checked>
      
      <label class="md-nav__link" for="__nav_3">
        Contributing Rules
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Contributing Rules" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Contributing Rules
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../index.html" class="md-nav__link">
        How Rules Work
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../evidence.html" class="md-nav__link">
        Rules' Evidence Field
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../context-aware.html" class="md-nav__link">
        What is considered a "Context Aware Rule"?
      </a>
    </li>
  

          
            
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Tutorial - Writing Your Own Rule
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="index.html" class="md-nav__link md-nav__link--active">
        Tutorial - Writing Your Own Rule
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#prerequisites" class="md-nav__link">
    Prerequisites
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#assumptions" class="md-nav__link">
    Assumptions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scenario" class="md-nav__link">
    Scenario
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-1-create-your-work-environment" class="md-nav__link">
    Step 1: Create your work environment
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-2-create-the-metadata-for-your-rule" class="md-nav__link">
    Step 2: Create the metadata for your rule
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-3-create-the-rule-class" class="md-nav__link">
    Step 3: Create the rule class
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-4-write-the-logic" class="md-nav__link">
    Step 4: Write the logic
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-5-update-the-should_run_rule-logic" class="md-nav__link">
    Step 5: Update the should_run_rule logic
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-6-add-tests" class="md-nav__link">
    Step 6: Add tests
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-7-run-unit-tests" class="md-nav__link">
    Step 7: Run unit tests
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-8-run-an-end-to-end-test-on-your-rule" class="md-nav__link">
    Step 8: Run an end-to-end test on your rule
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#wrap-it-up" class="md-nav__link">
    Wrap it up
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#parting-notes" class="md-nav__link">
    Parting notes
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#prerequisites" class="md-nav__link">
    Prerequisites
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#assumptions" class="md-nav__link">
    Assumptions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scenario" class="md-nav__link">
    Scenario
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-1-create-your-work-environment" class="md-nav__link">
    Step 1: Create your work environment
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-2-create-the-metadata-for-your-rule" class="md-nav__link">
    Step 2: Create the metadata for your rule
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-3-create-the-rule-class" class="md-nav__link">
    Step 3: Create the rule class
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-4-write-the-logic" class="md-nav__link">
    Step 4: Write the logic
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-5-update-the-should_run_rule-logic" class="md-nav__link">
    Step 5: Update the should_run_rule logic
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-6-add-tests" class="md-nav__link">
    Step 6: Add tests
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-7-run-unit-tests" class="md-nav__link">
    Step 7: Run unit tests
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-8-run-an-end-to-end-test-on-your-rule" class="md-nav__link">
    Step 8: Run an end-to-end test on your rule
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#wrap-it-up" class="md-nav__link">
    Wrap it up
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#parting-notes" class="md-nav__link">
    Parting notes
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/indeni/cloudrail-knowledge/docs/rules/tutorial/README.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="tutorial-writing-your-own-rule">Tutorial: Writing your own rule</h1>
<p>If you're arrived at this page before reading the <a href="../index.html">overview on rules</a>, 
please head there first and come back.</p>
<p>In this tutorial, we'll take you step by step through writing your own Cloudrail rule.</p>
<h2 id="prerequisites">Prerequisites</h2>
<ul>
<li>
<p>You need to have a basic understanding of Python. You do <em>not</em> need an expert level
    understanding.</p>
</li>
<li>
<p>Install your Python dev tool of choice. In this example, we'll by using PyCharm CE.</p>
</li>
</ul>
<h2 id="assumptions">Assumptions</h2>
<ul>
<li>
<p>This tutorial is written assuming you use MacOS, but can work similarly on Linux, Windows, etc.</p>
</li>
<li>
<p>We will create a new rule in its own directory. If you want to contribute to the main cloudrail-knowledge
    repository, you should clone the repository instead of setting up your own working directory.</p>
</li>
</ul>
<h2 id="scenario">Scenario</h2>
<p>In this tutorial we will be creating a rule which we'll use to list all of the roles that allow
third party access from AWS accounts that haven't been approved yet. The goal is to flush out roles
that were added without going through due process.</p>
<h2 id="step-1-create-your-work-environment">Step 1: Create your work environment</h2>
<p>Create a directory where you'll be saving your rules. For example, <code>~/code/cloudrail-sample-custom-rules</code>.
In this directory, create a <a href="https://docs.python.org/3/tutorial/venv.html">Python venv</a>, like so:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>python3 -m venv venv
</code></pre></div>
<p>Go into the venv:
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="nb">source</span> venv/bin/activate
</code></pre></div></p>
<p>And install the needed Python libraries:
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>pip install cloudrail-knowledge
</code></pre></div></p>
<p>Create the <code>src</code> (where the rule code will be) and <code>tests</code> (where tests will reside) directories:
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>mkdir src
<span class="linenos" data-linenos="2 "></span>mkdir tests
</code></pre></div></p>
<p>Set up your IDE to the directory you've created. For example, in PyCharm CE, this means
creating a New Project (under the File menu) and selecting the directory you created. PyCharm CE
will recognize the venv you created.</p>
<h2 id="step-2-create-the-metadata-for-your-rule">Step 2: Create the metadata for your rule</h2>
<p>All rules must have <a href="../index.html#Metadata">metadata</a>. In the <code>src</code> directory, create 
<code>rules_metadata.yaml</code> with the required information. Note that the root of the file must
be <code>rules_metadata</code>.</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="nt">rules_metadata</span><span class="p">:</span>
<span class="linenos" data-linenos=" 2 "></span>  <span class="p p-Indicator">-</span> <span class="nt">cloud_provider</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">amazon_web_services</span>
<span class="linenos" data-linenos=" 3 "></span>    <span class="nt">rule_id</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ensure_only_approved_third_parties_can_assume_roles</span>
<span class="linenos" data-linenos=" 4 "></span>    <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Ensure only approved third party accounts can assume roles</span>
<span class="linenos" data-linenos=" 5 "></span>    <span class="nt">severity</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">major</span>
<span class="linenos" data-linenos=" 6 "></span>    <span class="nt">description</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">We would like to control which third party accounts can assume roles in our environment.</span>
<span class="linenos" data-linenos=" 7 "></span>      <span class="l l-Scalar l-Scalar-Plain">This role has an approved-list of accounts which will be expanded over time.</span>
<span class="linenos" data-linenos=" 8 "></span>    <span class="nt">human_readable_logic</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Cloudrail will review all IAM roles&#39; trust policy and look at the accounts allowed.</span>
<span class="linenos" data-linenos=" 9 "></span>    <span class="nt">remediation_steps_console</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Remove the role, or add its account to the approved list in this rule.</span>
<span class="linenos" data-linenos="10 "></span>    <span class="nt">remediation_steps_tf</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Remove the aws_iam_role, or add the account to the approved list in this rule.</span>
<span class="linenos" data-linenos="11 "></span>    <span class="nt">rule_type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">non_context_aware</span>
<span class="linenos" data-linenos="12 "></span>    <span class="nt">security_layer</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">iam</span>
<span class="linenos" data-linenos="13 "></span>    <span class="nt">resource_type</span><span class="p">:</span>
<span class="linenos" data-linenos="14 "></span>    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">iam</span>
</code></pre></div>
<p>NOTE: If you're contributing to the cloudrail-knowledge repository, the metadata files already exist. You need
to add to them, depending on the cloud provider the rule applies to, instead of creating a new metadata file.</p>
<h2 id="step-3-create-the-rule-class">Step 3: Create the rule class</h2>
<p>The easiest way to do this is by finding an existing rule in the cloudrail-knowledge repository and copying it. Then
clean up the contents of the functions. The rule should be saved as a Python file in the <code>src</code> directory.</p>
<p>Your rule should now look like this:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span>
<span class="linenos" data-linenos=" 2 "></span><span class="kn">from</span> <span class="nn">cloudrail.knowledge.context.aws.aws_environment_context</span> <span class="kn">import</span> <span class="n">AwsEnvironmentContext</span>
<span class="linenos" data-linenos=" 3 "></span><span class="kn">from</span> <span class="nn">cloudrail.knowledge.rules.base_rule</span> <span class="kn">import</span> <span class="n">BaseRule</span><span class="p">,</span> <span class="n">Issue</span>
<span class="linenos" data-linenos=" 4 "></span><span class="kn">from</span> <span class="nn">cloudrail.knowledge.rules.rule_parameters.base_paramerter</span> <span class="kn">import</span> <span class="n">ParameterType</span>
<span class="linenos" data-linenos=" 5 "></span>
<span class="linenos" data-linenos=" 6 "></span>
<span class="linenos" data-linenos=" 7 "></span><span class="k">class</span> <span class="nc">EnsureOnlyAssumesThirdPartiesCanAssumeRoles</span><span class="p">(</span><span class="n">BaseRule</span><span class="p">):</span>
<span class="linenos" data-linenos=" 8 "></span>    <span class="k">def</span> <span class="nf">get_id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="linenos" data-linenos=" 9 "></span>        <span class="k">return</span> <span class="s1">&#39;ensure_only_approved_third_parties_can_assume_roles&#39;</span>
<span class="linenos" data-linenos="10 "></span>
<span class="linenos" data-linenos="11 "></span>    <span class="k">def</span> <span class="nf">get_needed_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ParameterType</span><span class="p">]:</span>
<span class="linenos" data-linenos="12 "></span>        <span class="k">return</span> <span class="p">[]</span>
<span class="linenos" data-linenos="13 "></span>
<span class="linenos" data-linenos="14 "></span>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env_context</span><span class="p">:</span> <span class="n">AwsEnvironmentContext</span><span class="p">,</span> <span class="n">parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">ParameterType</span><span class="p">,</span> <span class="nb">any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Issue</span><span class="p">]:</span>
<span class="linenos" data-linenos="15 "></span>        <span class="n">issues</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Issue</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos" data-linenos="16 "></span>
<span class="linenos" data-linenos="17 "></span>        <span class="k">return</span> <span class="n">issues</span>
<span class="linenos" data-linenos="18 "></span>
<span class="linenos" data-linenos="19 "></span>    <span class="k">def</span> <span class="nf">should_run_rule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environment_context</span><span class="p">:</span> <span class="n">AwsEnvironmentContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="linenos" data-linenos="20 "></span>        <span class="k">return</span> <span class="kc">True</span>
</code></pre></div>
<p>NOTE: The get_id needs to return the same id as you picked in the rule's metadata.</p>
<h2 id="step-4-write-the-logic">Step 4: Write the logic</h2>
<p>Within the execute function, we implement the logic of the rule. For this tutorial, we've
picked this:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env_context</span><span class="p">:</span> <span class="n">EnvironmentContext</span><span class="p">,</span> <span class="n">parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">ParameterType</span><span class="p">,</span> <span class="nb">any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Issue</span><span class="p">]:</span>
<span class="linenos" data-linenos=" 2 "></span>        <span class="n">issues</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Issue</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos" data-linenos=" 3 "></span>
<span class="linenos" data-linenos=" 4 "></span>        <span class="k">for</span> <span class="n">role</span> <span class="ow">in</span> <span class="n">env_context</span><span class="o">.</span><span class="n">roles</span><span class="p">:</span>
<span class="linenos" data-linenos=" 5 "></span>            <span class="k">for</span> <span class="n">statement</span> <span class="ow">in</span> <span class="n">role</span><span class="o">.</span><span class="n">assume_role_policy</span><span class="o">.</span><span class="n">statements</span><span class="p">:</span>
<span class="linenos" data-linenos=" 6 "></span>                <span class="k">if</span> <span class="n">statement</span><span class="o">.</span><span class="n">effect</span> <span class="o">==</span> <span class="n">StatementEffect</span><span class="o">.</span><span class="n">ALLOW</span><span class="p">:</span>
<span class="linenos" data-linenos=" 7 "></span>                    <span class="k">for</span> <span class="n">principal</span> <span class="ow">in</span> <span class="n">statement</span><span class="o">.</span><span class="n">principal</span><span class="o">.</span><span class="n">principal_values</span><span class="p">:</span>
<span class="linenos" data-linenos=" 8 "></span>                        <span class="k">if</span> <span class="n">arn_utils</span><span class="o">.</span><span class="n">is_valid_arn</span><span class="p">(</span><span class="n">principal</span><span class="p">)</span> <span class="ow">and</span> <span class="n">arn_utils</span><span class="o">.</span><span class="n">get_arn_account_id</span><span class="p">(</span><span class="n">principal</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">approved_list_of_third_parties</span><span class="p">:</span>
<span class="linenos" data-linenos=" 9 "></span>                            <span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Issue</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The IAM role `</span><span class="si">{</span><span class="n">role</span><span class="o">.</span><span class="n">get_friendly_name</span><span class="p">()</span><span class="si">}</span><span class="s1">` has a trust policy that allows account `</span><span class="si">{</span> <span class="n">arn_utils</span><span class="o">.</span><span class="n">get_arn_account_id</span><span class="p">(</span><span class="n">principal</span><span class="p">)</span><span class="si">}</span><span class="s1">` &#39;</span>
<span class="linenos" data-linenos="10 "></span>                                        <span class="sa">f</span><span class="s1">&#39;to assume it but that is not in the list of pre-approved third-party accounts&#39;</span><span class="p">,</span> <span class="n">role</span><span class="p">,</span> <span class="n">role</span><span class="p">))</span>
<span class="linenos" data-linenos="11 "></span>        <span class="k">return</span> <span class="n">issues</span>
</code></pre></div>
<p>The above code requires that you also add imports at the top of the class:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="kn">from</span> <span class="nn">cloudrail.knowledge.utils.arn_utils</span> <span class="kn">import</span> <span class="n">build_arn</span>
<span class="linenos" data-linenos="2 "></span><span class="kn">from</span> <span class="nn">cloudrail.knowledge.context.aws.iam.policy_statement</span> <span class="kn">import</span> <span class="n">StatementEffect</span>
</code></pre></div>
<p>The logic here iterates over all the roles in the context (which represents all roles in the 
environment - both those that already exist and those being created). For each role, it iterates
over the assume role policy's statements. For each statement, it looks at the principals included in it.
For each principal, it checks to see if its AWS account ID is in a predetermined list of accounts
we're approving of.</p>
<p>If it's not in the list, we create an Issue with the relevant information.</p>
<p>The list of approved third party accounts is defined like so (add the <strong>init</strong> function at the top of the
Python class):
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos" data-linenos="2 "></span>        <span class="bp">self</span><span class="o">.</span><span class="n">approved_list_of_third_parties</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
<span class="linenos" data-linenos="3 "></span>            <span class="s2">&quot;645376637575&quot;</span><span class="p">,</span>  <span class="c1"># Indeni Cloudrail</span>
<span class="linenos" data-linenos="4 "></span>            <span class="s2">&quot;464622532012&quot;</span><span class="p">,</span>  <span class="c1"># DataDog</span>
<span class="linenos" data-linenos="5 "></span>        <span class="p">]</span>
</code></pre></div></p>
<h2 id="step-5-update-the-should_run_rule-logic">Step 5: Update the should_run_rule logic</h2>
<p>Before running the rule, the Cloudrail engine will call <code>should_run_rule</code> and will only
continue if it returns <code>True</code>. Right now, we have it returning <code>True</code> always, but we should update
that so it only does so if there are roles to review:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>    <span class="k">def</span> <span class="nf">should_run_rule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environment_context</span><span class="p">:</span> <span class="n">EnvironmentContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="linenos" data-linenos="2 "></span>        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">environment_context</span><span class="o">.</span><span class="n">roles</span><span class="p">)</span>
</code></pre></div>
<p>There are two reasons to do this:</p>
<ol>
<li>
<p>To save on run time, for CPU-intensive rules where the logic might execute even
    when it's not needed.</p>
</li>
<li>
<p>More importantly, we do this to signal to the user that the rule applies to their
    environment. If it doesn't, it will be marked as Skipped. This helps users know
    that Cloudrail understands which rules apply, and which don't, to their environment.</p>
</li>
</ol>
<h2 id="step-6-add-tests">Step 6: Add tests</h2>
<p>At this point, our rule's code is complete. We now need to add tests.</p>
<p>NOTE: In software development, there's the concept of TDD (test driven development)
where you write the tests first, and then your logic. You can apply that to rule writing
as well. We didn't take that path in this tutorial to make it clearer for the reader.</p>
<p>In the <code>tests</code> directory (remember, it's next to the <code>src</code> directory), we create our
test class. This is the test we need for the above rule:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kn">import</span> <span class="nn">unittest</span>
<span class="linenos" data-linenos=" 2 "></span>
<span class="linenos" data-linenos=" 3 "></span><span class="kn">from</span> <span class="nn">cloudrail.knowledge.context.aws.account.account</span> <span class="kn">import</span> <span class="n">Account</span>
<span class="linenos" data-linenos=" 4 "></span><span class="kn">from</span> <span class="nn">cloudrail.knowledge.context.aws.iam.policy</span> <span class="kn">import</span> <span class="n">AssumeRolePolicy</span>
<span class="linenos" data-linenos=" 5 "></span><span class="kn">from</span> <span class="nn">cloudrail.knowledge.context.aws.iam.policy_statement</span> <span class="kn">import</span> <span class="n">PolicyStatement</span><span class="p">,</span> <span class="n">StatementEffect</span>
<span class="linenos" data-linenos=" 6 "></span><span class="kn">from</span> <span class="nn">cloudrail.knowledge.context.aws.iam.principal</span> <span class="kn">import</span> <span class="n">Principal</span><span class="p">,</span> <span class="n">PrincipalType</span>
<span class="linenos" data-linenos=" 7 "></span><span class="kn">from</span> <span class="nn">cloudrail.knowledge.context.aws.iam.role</span> <span class="kn">import</span> <span class="n">Role</span>
<span class="linenos" data-linenos=" 8 "></span><span class="kn">from</span> <span class="nn">cloudrail.knowledge.context.aws.aws_environment_context</span> <span class="kn">import</span> <span class="n">AwsEnvironmentContext</span>
<span class="linenos" data-linenos=" 9 "></span><span class="kn">from</span> <span class="nn">cloudrail.knowledge.rules.base_rule</span> <span class="kn">import</span> <span class="n">RuleResultType</span>
<span class="linenos" data-linenos="10 "></span><span class="kn">from</span> <span class="nn">src.ensure_only_approved_third_parties_can_assume_roles</span> <span class="kn">import</span> <span class="n">EnsureOnlyAssumesThirdPartiesCanAssumeRoles</span>
<span class="linenos" data-linenos="11 "></span>
<span class="linenos" data-linenos="12 "></span>
<span class="linenos" data-linenos="13 "></span><span class="k">class</span> <span class="nc">TestEnsureOnlyAssumesThirdPartiesCanAssumeRoles</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
<span class="linenos" data-linenos="14 "></span>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos" data-linenos="15 "></span>        <span class="bp">self</span><span class="o">.</span><span class="n">rule</span> <span class="o">=</span> <span class="n">EnsureOnlyAssumesThirdPartiesCanAssumeRoles</span><span class="p">()</span>
<span class="linenos" data-linenos="16 "></span>
<span class="linenos" data-linenos="17 "></span>    <span class="k">def</span> <span class="nf">test_ensure_only_approved_third_parties_can_assume_roles_fail</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos" data-linenos="18 "></span>        <span class="c1"># Arrange</span>
<span class="linenos" data-linenos="19 "></span>        <span class="n">context</span> <span class="o">=</span> <span class="n">AwsEnvironmentContext</span><span class="p">()</span>
<span class="linenos" data-linenos="20 "></span>
<span class="linenos" data-linenos="21 "></span>        <span class="n">account</span> <span class="o">=</span> <span class="n">Account</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<span class="linenos" data-linenos="22 "></span>        <span class="n">context</span><span class="o">.</span><span class="n">accounts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">account</span><span class="p">)</span>
<span class="linenos" data-linenos="23 "></span>
<span class="linenos" data-linenos="24 "></span>        <span class="n">role</span> <span class="o">=</span> <span class="n">Role</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;don&#39;t know&quot;</span><span class="p">,</span> <span class="s2">&quot;not_approved_role&quot;</span><span class="p">,</span> <span class="p">[],</span> <span class="s2">&quot;not_approved_role&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="linenos" data-linenos="25 "></span>        <span class="n">context</span><span class="o">.</span><span class="n">roles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">role</span><span class="p">)</span>
<span class="linenos" data-linenos="26 "></span>
<span class="linenos" data-linenos="27 "></span>        <span class="n">principal</span> <span class="o">=</span> <span class="n">Principal</span><span class="p">(</span><span class="n">principal_type</span><span class="o">=</span><span class="n">PrincipalType</span><span class="o">.</span><span class="n">AWS</span><span class="p">,</span> <span class="n">principal_values</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;arn:aws:iam::123456789012:root&quot;</span><span class="p">])</span>
<span class="linenos" data-linenos="28 "></span>
<span class="linenos" data-linenos="29 "></span>        <span class="n">role_assume_policy</span> <span class="o">=</span> <span class="n">AssumeRolePolicy</span><span class="p">(</span>
<span class="linenos" data-linenos="30 "></span>            <span class="n">account</span><span class="o">.</span><span class="n">account_name</span><span class="p">,</span> <span class="n">role</span><span class="o">.</span><span class="n">role_name</span><span class="p">,</span>
<span class="linenos" data-linenos="31 "></span>            <span class="n">role</span><span class="o">.</span><span class="n">arn</span><span class="p">,</span> <span class="p">[</span><span class="n">PolicyStatement</span><span class="p">(</span>
<span class="linenos" data-linenos="32 "></span>                <span class="n">StatementEffect</span><span class="o">.</span><span class="n">ALLOW</span><span class="p">,</span>
<span class="linenos" data-linenos="33 "></span>                <span class="p">[</span><span class="s2">&quot;assume role etc&quot;</span><span class="p">],</span>
<span class="linenos" data-linenos="34 "></span>                <span class="p">[</span><span class="s2">&quot;*&quot;</span><span class="p">],</span>
<span class="linenos" data-linenos="35 "></span>                <span class="n">principal</span><span class="p">,</span>
<span class="linenos" data-linenos="36 "></span>                <span class="s1">&#39;test123&#39;</span><span class="p">,</span> <span class="p">)],</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="linenos" data-linenos="37 "></span>        <span class="n">role</span><span class="o">.</span><span class="n">assume_role_policy</span> <span class="o">=</span> <span class="n">role_assume_policy</span>
<span class="linenos" data-linenos="38 "></span>
<span class="linenos" data-linenos="39 "></span>        <span class="c1"># Act</span>
<span class="linenos" data-linenos="40 "></span>        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rule</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="p">{})</span>
<span class="linenos" data-linenos="41 "></span>
<span class="linenos" data-linenos="42 "></span>        <span class="c1"># Assert</span>
<span class="linenos" data-linenos="43 "></span>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">RuleResultType</span><span class="o">.</span><span class="n">FAILED</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
<span class="linenos" data-linenos="44 "></span>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">issues</span><span class="p">))</span>
<span class="linenos" data-linenos="45 "></span>
<span class="linenos" data-linenos="46 "></span>    <span class="k">def</span> <span class="nf">test_ensure_only_approved_third_parties_can_assume_roles_pass</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos" data-linenos="47 "></span>        <span class="c1"># Arrange</span>
<span class="linenos" data-linenos="48 "></span>        <span class="n">context</span> <span class="o">=</span> <span class="n">AwsEnvironmentContext</span><span class="p">()</span>
<span class="linenos" data-linenos="49 "></span>
<span class="linenos" data-linenos="50 "></span>        <span class="n">account</span> <span class="o">=</span> <span class="n">Account</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<span class="linenos" data-linenos="51 "></span>        <span class="n">context</span><span class="o">.</span><span class="n">accounts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">account</span><span class="p">)</span>
<span class="linenos" data-linenos="52 "></span>
<span class="linenos" data-linenos="53 "></span>        <span class="n">role</span> <span class="o">=</span> <span class="n">Role</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;don&#39;t know&quot;</span><span class="p">,</span> <span class="s2">&quot;approved_role&quot;</span><span class="p">,</span> <span class="p">[],</span> <span class="s2">&quot;approved_role&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="linenos" data-linenos="54 "></span>        <span class="n">context</span><span class="o">.</span><span class="n">roles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">role</span><span class="p">)</span>
<span class="linenos" data-linenos="55 "></span>
<span class="linenos" data-linenos="56 "></span>        <span class="n">principal</span> <span class="o">=</span> <span class="n">Principal</span><span class="p">(</span><span class="n">principal_type</span><span class="o">=</span><span class="n">PrincipalType</span><span class="o">.</span><span class="n">AWS</span><span class="p">,</span> <span class="n">principal_values</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;arn:aws:iam::645376637575:root&quot;</span><span class="p">])</span>
<span class="linenos" data-linenos="57 "></span>
<span class="linenos" data-linenos="58 "></span>        <span class="n">role_assume_policy</span> <span class="o">=</span> <span class="n">AssumeRolePolicy</span><span class="p">(</span>
<span class="linenos" data-linenos="59 "></span>            <span class="n">account</span><span class="o">.</span><span class="n">account_name</span><span class="p">,</span> <span class="n">role</span><span class="o">.</span><span class="n">role_name</span><span class="p">,</span>
<span class="linenos" data-linenos="60 "></span>            <span class="n">role</span><span class="o">.</span><span class="n">arn</span><span class="p">,</span> <span class="p">[</span><span class="n">PolicyStatement</span><span class="p">(</span>
<span class="linenos" data-linenos="61 "></span>                <span class="n">StatementEffect</span><span class="o">.</span><span class="n">ALLOW</span><span class="p">,</span>
<span class="linenos" data-linenos="62 "></span>                <span class="p">[</span><span class="s2">&quot;assume role etc&quot;</span><span class="p">],</span>
<span class="linenos" data-linenos="63 "></span>                <span class="p">[</span><span class="s2">&quot;*&quot;</span><span class="p">],</span>
<span class="linenos" data-linenos="64 "></span>                <span class="n">principal</span><span class="p">,</span>
<span class="linenos" data-linenos="65 "></span>                <span class="s1">&#39;test123&#39;</span><span class="p">,</span> <span class="p">)],</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="linenos" data-linenos="66 "></span>        <span class="n">role</span><span class="o">.</span><span class="n">assume_role_policy</span> <span class="o">=</span> <span class="n">role_assume_policy</span>
<span class="linenos" data-linenos="67 "></span>
<span class="linenos" data-linenos="68 "></span>        <span class="c1"># Act</span>
<span class="linenos" data-linenos="69 "></span>        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rule</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="p">{})</span>
<span class="linenos" data-linenos="70 "></span>
<span class="linenos" data-linenos="71 "></span>        <span class="c1"># Assert</span>
<span class="linenos" data-linenos="72 "></span>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">RuleResultType</span><span class="o">.</span><span class="n">SUCCESS</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
<span class="linenos" data-linenos="73 "></span>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">issues</span><span class="p">))</span>
</code></pre></div>
<p>Let's look at a few things here:</p>
<ol>
<li>Note the <code>setUp</code> function declares the rule we're testing against.</li>
<li>There are two test functions one for <code>_fail</code> and one for <code>_pass</code>. The idea is 
    that we test the rule catching a violation ("fail") and the rule not catching a violation
   (because the configuration is ok - which is a "pass").</li>
<li>In each test function, we "build" a mock context that the rule runs against.
   This is important to understand - we're actually creating here the objects that
   Cloudrail would normally create as part of the context building. We do this in
   order to make this truly a unit-test, where the rule is tested against mock
   content.</li>
<li>If you compare the test functions, notice the <code>principal</code> defined and what 
    AWS account ID it's using.</li>
</ol>
<p>Generally, you'd want to try and add as many test cases as makes sense, to simulate
different scenarios.</p>
<p><strong>QUESTION:</strong> Why can't I just supply a Terraform code to test again?</p>
<p><strong>ANSWER:</strong> Our context has multiple sources of input, including multiple live environments
(cloud accounts) and one or more infrastructure-as-code languages. The building phase
in our context translates all of these sources into our central context model. Testing
of our context is done in a separate, private, repository. So when testing rules, you should
assume the translation from those different sources of input is already done, and you can
rely on the context to be built.</p>
<h2 id="step-7-run-unit-tests">Step 7: Run unit tests</h2>
<p>Now, you should run the test class. In PyCharm, it's as easy as clicking on the 
green arrow to the left of the test class's name:</p>
<p><img alt="Run Test" src="imgs/run_test_class.png" /></p>
<p>If you've done everything correctly, the tests should pass. If they fail, click on
the failed test and look at the log to see what may be wrong.</p>
<h2 id="step-8-run-an-end-to-end-test-on-your-rule">Step 8: Run an end-to-end test on your rule</h2>
<p>Want to see what kind of output Cloudrail will <em>actually</em> generate for your rule? Follow
these steps:</p>
<ol>
<li>Create a main.tf that simulates the issue you want to catch. In our example, this
    would work:</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span>provider &quot;aws&quot; {
<span class="linenos" data-linenos=" 2 "></span>  region = &quot;us-east-1&quot;
<span class="linenos" data-linenos=" 3 "></span>}
<span class="linenos" data-linenos=" 4 "></span>
<span class="linenos" data-linenos=" 5 "></span>resource &quot;aws_iam_role&quot; &quot;myexample&quot; {
<span class="linenos" data-linenos=" 6 "></span>  name = &quot;myexample&quot;
<span class="linenos" data-linenos=" 7 "></span>  assume_role_policy = &lt;&lt;EOF
<span class="linenos" data-linenos=" 8 "></span>{
<span class="linenos" data-linenos=" 9 "></span>  &quot;Version&quot;: &quot;2012-10-17&quot;,
<span class="linenos" data-linenos="10 "></span>  &quot;Statement&quot;: [
<span class="linenos" data-linenos="11 "></span>    {
<span class="linenos" data-linenos="12 "></span>      &quot;Sid&quot;: &quot;&quot;,
<span class="linenos" data-linenos="13 "></span>      &quot;Effect&quot;: &quot;Allow&quot;,
<span class="linenos" data-linenos="14 "></span>      &quot;Principal&quot;: {
<span class="linenos" data-linenos="15 "></span>        &quot;AWS&quot;: &quot;arn:aws:iam::111122223333:user/LiJuan&quot;
<span class="linenos" data-linenos="16 "></span>      },
<span class="linenos" data-linenos="17 "></span>      &quot;Action&quot;: &quot;sts:AssumeRole&quot;
<span class="linenos" data-linenos="18 "></span>    }
<span class="linenos" data-linenos="19 "></span>  ]
<span class="linenos" data-linenos="20 "></span>}
<span class="linenos" data-linenos="21 "></span>EOF
<span class="linenos" data-linenos="22 "></span>}
</code></pre></div>
<ol>
<li>
<p>Generate a plan for the above file (<code>terraform init</code>, <code>terraform plan -out=plan.out</code>).</p>
</li>
<li>
<p>Run Cloudrail with this plan, using your custom rule:</p>
</li>
</ol>
<p><div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>docker run --rm -it  -v <span class="nv">$PWD</span>:/data -v cloudrail:/indeni indeni/cloudrail-cli run -p plan.out --auto-approve -v --custom-rules src
</code></pre></div>
Note the <code>--custom-rules</code> at the end, with the directory where the rule is located.</p>
<p>Your results should look like this:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span> Reading custom rules...
<span class="linenos" data-linenos=" 2 "></span> Preparing a filtered Terraform plan locally before uploading to Cloudrail Service...
<span class="linenos" data-linenos=" 3 "></span> Re-running your Terraform plan through a customized &#39;terraform plan&#39; to generate needed context data...
<span class="linenos" data-linenos=" 4 "></span> Filtering and processing Terraform data...
<span class="linenos" data-linenos=" 5 "></span> Obfuscating IP addresses...
<span class="linenos" data-linenos=" 6 "></span> Submitting Terraform data to the Cloudrail Service...
<span class="linenos" data-linenos=" 7 "></span> Your job id is: 4a2924aa-378e-47b0-8340-ed7e97071760
<span class="linenos" data-linenos=" 8 "></span> Building simulated graph model, representing how the cloud account will look like if the plan were to be applied...
<span class="linenos" data-linenos=" 9 "></span> Running context-aware rules...
<span class="linenos" data-linenos="10 "></span> Running custom rules...
<span class="linenos" data-linenos="11 "></span> Returning results, almost done!
<span class="linenos" data-linenos="12 "></span> Assessment complete, fetching results...
<span class="linenos" data-linenos="13 "></span>WARNINGs found:
<span class="linenos" data-linenos="14 "></span>Rule: Ensure only approved third party accounts can assume roles
<span class="linenos" data-linenos="15 "></span> - 1 Resources Exposed:
<span class="linenos" data-linenos="16 "></span>-----------------------------------------------
<span class="linenos" data-linenos="17 "></span>   - Exposed Resource: [aws_iam_role.myexample] (main.tf:5)
<span class="linenos" data-linenos="18 "></span>     Violating Resource: [aws_iam_role.myexample]  (main.tf:5)
<span class="linenos" data-linenos="19 "></span>     Evidence:
<span class="linenos" data-linenos="20 "></span>             | The IAM role aws_iam_role.myexample has a trust policy that allows account 111122223333 to assume it but that is not in the list of pre-approved third-party accounts
</code></pre></div>
<h2 id="wrap-it-up">Wrap it up</h2>
<p>That's it for the rule development. You can now either submit it as a PR to cloudrail-knowledge,
or save it in your own repository for use with Cloudrail. </p>
<h2 id="parting-notes">Parting notes</h2>
<p>By default, Cloudrail will only show violations for resources that are managed in infrastructure-as-code. If, for your rule,
you want it to show violatiosn for all resources, even those that only existing in the live environment,
add this to your rule:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>    <span class="nd">@staticmethod</span>
<span class="linenos" data-linenos="2 "></span>    <span class="k">def</span> <span class="nf">filter_non_iac_managed_issues</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="linenos" data-linenos="3 "></span>        <span class="k">return</span> <span class="kc">False</span>
</code></pre></div>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../context-aware.html" class="md-footer__link md-footer__link--prev" aria-label="Previous: What is considered a &#34;Context Aware Rule&#34;?" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              What is considered a "Context Aware Rule"?
            </div>
          </div>
        </a>
      
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            indeni
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../assets/javascripts/workers/search.b0710199.min.js", "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.76f349be.min.js"></script>
      
    
  </body>
</html>